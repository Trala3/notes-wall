<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="true">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#1a1a1a">
    <title>自适应高度便签应用</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #1a1a1a;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* 任务栏样式 */
        .taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background-color: #2d2d30;
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 1000;
            box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.5);
        }
        
        .taskbar-icon {
            width: 30px;
            height: 30px;
            background-color: #0078d7;
            border-radius: 5px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .taskbar-icon:hover {
            background-color: #106ebe;
            transform: translateY(-2px);
        }
        
        /* 便签容器 - 窗口样式 */
        .sticky-note {
            position: absolute;
            width: 220px;
            min-height: 80px;
            max-height: none;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 1;
            cursor: move;
            transition: transform 0.3s ease, box-shadow 0.3s ease, z-index 0.1s ease;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
            backdrop-filter: blur(10px);
            overflow: hidden;
            height: auto;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .sticky-note {
                width: 180px;
                min-height: 70px;
            }
            
            .sticky-note-content {
                font-size: 14px !important;
                padding: 10px 12px 6px !important;
            }
            
            .sticky-note-header {
                padding: 10px 12px;
            }
            
            .sticky-note-title {
                font-size: 13px;
            }
            
            .control-button {
                width: 14px;
                height: 14px;
            }
            
            .controls {
                position: fixed;
                top: auto;
                bottom: 60px;
                right: 10px;
                left: 10px;
                flex-direction: row;
                justify-content: space-around;
                z-index: 1000;
                gap: 8px;
            }
            
            .control-btn {
                font-size: 13px;
                padding: 10px 12px;
                flex: 1;
            }
            
            .status-indicator {
                position: fixed;
                top: 10px;
                left: 10px;
                right: 10px;
                text-align: center;
                font-size: 13px;
            }
        }
        
        .sticky-note:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.15);
            z-index: 10;
        }
        
        /* 便签标题栏 */
        .sticky-note-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .sticky-note-title {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .title-icon {
            width: 16px;
            height: 16px;
            background-color: #666;
            border-radius: 2px;
        }
        
        /* 窗口控制按钮 */
        .window-controls {
            display: flex;
            gap: 6px;
        }
        
        .control-button {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
        }
        
        .control-button:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .minimize-btn {
            background-color: #ffc107;
        }
        
        .maximize-btn {
            background-color: #4caf50;
        }
        
        .close-btn {
            background-color: #f44336;
        }
        
        /* 便签内容区域 - 自适应高度 */
        .sticky-note-content {
            padding: 12px 16px 8px;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.5;
            overflow-wrap: break-word;
            text-align: center;
            letter-spacing: 0.3px;
            flex-grow: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: auto;
            height: auto;
            margin-bottom: 0;
        }
        
        /* 首行居中样式 */
        .sticky-note-content::first-line {
            text-align: center;
            font-weight: 600;
        }
        
        /* 现代化便签颜色方案 */
        .note-yellow {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            color: #333;
        }
        
        .note-blue {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
        }
        
        .note-green {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
        }
        
        .note-purple {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            color: #6a1b9a;
        }
        
        .note-pink {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
            color: #c2185b;
        }
        
        .note-orange {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #e65100;
        }
        
        .note-red {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
        }
        
        .note-cyan {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            color: #006064;
        }
        
        /* 控制按钮 - 现代化样式 */
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .control-btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 12px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .control-btn:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        #addBtn {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        }
        
        #addBtn:hover {
            background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%);
        }
        
        #startBtn {
            background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%);
        }
        
        #startBtn:hover {
            background: linear-gradient(135deg, #42A5F5 0%, #1565C0 100%);
        }
        
        #stopBtn {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        #stopBtn:hover {
            background: linear-gradient(135deg, #EF5350 0%, #C62828 100%);
        }
        
        /* 状态指示器 */
        .status-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1000;
        }
        
        .status-auto {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        }
        
        .status-stopped {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        /* 弹出动画 */
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.5) rotate(-5deg);
            }
            70% {
                transform: scale(1.05) rotate(2deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }
        
        /* 关闭动画 */
        @keyframes popOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
            }
        }
    </style>
</head>
<body>
    <div class="status-indicator status-auto">自动添加中...</div>
    
    <div class="controls">
        <button id="addBtn" class="control-btn">添加便签</button>
        <button id="startBtn" class="control-btn">开始自动添加</button>
        <button id="stopBtn" class="control-btn">停止自动添加</button>
    </div>
    
    <div class="taskbar">
        <div class="taskbar-icon">开</div>
        <div class="taskbar-icon">文</div>
        <div class="taskbar-icon">Ch</div>
    </div>

    <script>
        // 便签内容库 - 从用户图片中提取的文本
        const noteContents = [
            "阳光总在风雨后",
            "每天都是新的开始",
            "做最棒的自己",
            "保持热爱，奔赴山海",
            "你值得拥有美好",
            "微笑是最好的名片",
            "今天也要元气满满",
            "相信自己，无限可能",
            "坚持就是胜利",
            "你比想象中更强大",
            "今天也要闪闪发光",
            "保持初心，方得始终",
            "你是独一无二的",
            "今天也要开启新的一天",
            "宣你！", "恶搞", "保持积极", "努力学习", 
            "今天也要开心鸭",
            "努力终将开花结果",
            "你笑起来真好看",
            "今天也要加油鸭",
            "保持清醒，保持可爱",
            "你值得被温柔以待",
            "今天也要好好生活",
            "保持善良，保持可爱",
            "你比昨天更优秀",
            "今天也要微笑面对",
            "保持热爱，保持期待",
            "你值得拥有幸福",
            "今天也要好好爱自己",
            "保持乐观，保持积极",
            "你比想象中更坚强",
            "今天也要好好吃饭",
            "保持微笑，保持快乐",
            "你值得拥有梦想",
            "今天也要坚持学习",
            "今天很开心",
            "好好爱自己",
            "梦想成真",
            "加油加油",
            "记得喝水",
            "天天开心",
            "珍惜每一天",
            "保持微笑",
            "我想你了",
            "今天过得开心嘛",
            "好好吃饭",
            "努力工作",
            "明天会更好",
            "坚持就是胜利",
            "相信自己",
            "你很棒",
            "一切顺利",
            "太胖了，多穿衣服",
            "金榜题名",
            "好好照顾自己",
            "保持好心情",
            "今天记得开心哦",
            "为明天努力",
            "珍惜当下"
        ];
        
        // 便签颜色类名 - 现代化配色
        const noteColors = [
            'note-yellow', 'note-blue', 'note-green', 'note-purple',
            'note-pink', 'note-orange', 'note-red', 'note-cyan'
        ];
        
        // 窗口标题
        const windowTitles = [
            '恶搞', '消息', '便签', '提醒', '通知', '对话', '备忘录'
        ];
        
        let autoAddInterval;
        let noteCount = 0;
        const maxNotes = 30; // 最大便签数量
        let zIndexCounter = 1;
        let isAutoAdding = true;
        
        // 初始化函数
        function init() {
            // 初始添加几个便签
            for (let i = 0; i < 5; i++) {
                addStickyNote();
            }
            
            // 设置自动添加便签
            startAutoAdd();
            
            // 添加按钮事件（支持触摸事件）
            function setupButtonEvents(buttonId, callback) {
                const button = document.getElementById(buttonId);
                button.addEventListener('click', callback);
                button.addEventListener('touchstart', callback, { passive: false });
            }
            
            setupButtonEvents('addBtn', () => {
                if (noteCount < maxNotes) {
                    addStickyNote();
                } else {
                    // 移动端友好的提示
                    if (window.innerWidth <= 768) {
                        const notification = document.createElement('div');
                        notification.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: rgba(0, 0, 0, 0.8);
                            color: white;
                            padding: 15px 20px;
                            border-radius: 8px;
                            z-index: 2000;
                            font-size: 14px;
                            text-align: center;
                            min-width: 200px;
                        `;
                        notification.textContent = '已达到最大便签数量！';
                        document.body.appendChild(notification);
                        setTimeout(() => {
                            notification.remove();
                        }, 2000);
                    } else {
                        alert('已达到最大便签数量！');
                    }
                }
            });
            
            setupButtonEvents('startBtn', () => {
                startAutoAdd();
            });
            
            setupButtonEvents('stopBtn', () => {
                stopAutoAdd();
            });
        }
        
        // 简化版自动添加函数 - 优化微信兼容性
        // 全局可访问的自动添加函数，完全支持移动设备
        window.startAutoAdd = function() {
            // 清除现有定时器
            if (window.autoAddInterval) {
                clearInterval(window.autoAddInterval);
                window.autoAddInterval = null;
            }
            
            // 获取间隔时间，优先使用全局设置的优化值
            const intervalTime = window.autoAddIntervalTime || 5000; // 移动设备默认5秒
            
            // 确保noteCount已初始化
            window.noteCount = window.noteCount || 0;
            
            // 使用window对象存储定时器，避免局部变量问题
            window.autoAddInterval = setInterval(function() {
                try {
                    // 检查是否达到最大便签数，使用全局变量
                    if (window.noteCount >= window.maxNotes) {
                        clearInterval(window.autoAddInterval);
                        window.autoAddInterval = null;
                        return;
                    }
                    
                    // 安全添加便签，传递移动设备标志
                    if (typeof window.addStickyNote === 'function') {
                        // 传递简化动画标志
                        window.addStickyNote({ simplified: window.disableComplexAnimations });
                        window.noteCount++;
                    }
                } catch (e) {
                    // 出错时停止自动添加
                    if (window.autoAddInterval) {
                        clearInterval(window.autoAddInterval);
                        window.autoAddInterval = null;
                    }
                    console.log('自动添加便签时出错:', e);
                }
            }, intervalTime);
            
            // 更新全局状态
            window.isAutoAdding = true;
            updateStatusIndicator();
        }
        
        // 全局可访问的停止自动添加函数
        window.stopAutoAdd = function() {
            // 使用window对象引用，与startAutoAdd保持一致
            if (window.autoAddInterval) {
                clearInterval(window.autoAddInterval);
                window.autoAddInterval = null;
            }
            
            // 更新全局状态
            window.isAutoAdding = false;
            
            // 确保updateStatusIndicator函数存在才调用
            if (typeof window.updateStatusIndicator === 'function') {
                window.updateStatusIndicator();
            }
        }
        
        // 更新状态指示器
        function updateStatusIndicator() {
            const indicator = document.querySelector('.status-indicator');
            if (isAutoAdding) {
                indicator.textContent = '自动添加中...';
                indicator.className = 'status-indicator status-auto';
            } else {
                indicator.textContent = '已停止自动添加';
                indicator.className = 'status-indicator status-stopped';
            }
        }
        
        // 添加便签函数
        // 全局可访问的添加便签函数，支持简化模式
        window.addStickyNote = function(options) {
            // 确保options是对象
            options = options || {};
            const simplified = options.simplified || false;
            
            // 确保全局变量已初始化
            window.zIndexCounter = window.zIndexCounter || 1;
            window.zIndexCounter++;
            
            try {
                // 创建便签元素
                const stickyNote = document.createElement('div');
                const colorClass = typeof window.getRandomColor === 'function' ? window.getRandomColor() : 'color-1';
                stickyNote.className = `sticky-note ${colorClass}`;
                
                // 在简化模式下禁用动画以提高性能
                if (!simplified && typeof document.createElement('div').animate !== 'undefined') {
                    stickyNote.style.animation = 'popIn 0.3s ease-out forwards'; // 简化动画时间
                }
                stickyNote.style.zIndex = window.zIndexCounter;
            
            // 随机位置（避免完全重叠，优化移动端适配）
            const isMobile = window.innerWidth <= 768;
            const noteWidth = isMobile ? 180 : 220;
            const noteHeight = isMobile ? 70 : 80;
            
            // 安全计算位置，确保在视口内
            const viewportWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
            const viewportHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
            
            const randomLeft = Math.random() * (viewportWidth - noteWidth - 20) + 10;
            const randomTop = Math.random() * (viewportHeight - noteHeight - 80) + 10; // 留出底部控制栏空间
            
            stickyNote.style.left = `${randomLeft}px`;
            stickyNote.style.top = `${randomTop}px`;
            stickyNote.style.touchAction = 'none'; // 优化触摸行为
            
            // 获取随机内容
            const content = getRandomContent();
            
            // 便签内容 - 窗口样式
            stickyNote.innerHTML = `
                <div class="sticky-note-header">
                    <div class="sticky-note-title">
                        <div class="title-icon"></div>
                        ${getRandomTitle()}
                    </div>
                    <div class="window-controls">
                        <div class="control-button minimize-btn">_</div>
                        <div class="control-button maximize-btn">□</div>
                        <div class="control-button close-btn">×</div>
                    </div>
                </div>
                <div class="sticky-note-content">${content}</div>
            `;
            
            // 添加到页面
            document.body.appendChild(stickyNote);
            
            // 自适应高度调整
            adjustNoteHeight(stickyNote);
            
            // 添加窗口控制功能
            const minimizeBtn = stickyNote.querySelector('.minimize-btn');
            const maximizeBtn = stickyNote.querySelector('.maximize-btn');
            const closeBtn = stickyNote.querySelector('.close-btn');
            
            // 最小化功能（支持触摸事件）
            function handleMinimize(e) {
                e.stopPropagation();
                stickyNote.style.transform = 'scale(0.1)';
                stickyNote.style.opacity = '0.5';
                setTimeout(() => {
                    stickyNote.style.transform = '';
                    stickyNote.style.opacity = '1';
                }, 500);
            }
            minimizeBtn.addEventListener('click', handleMinimize);
            minimizeBtn.addEventListener('touchstart', handleMinimize, { passive: false });
            
            // 最大化功能（支持触摸事件）
            function handleMaximize(e) {
                e.stopPropagation();
                const currentScale = window.getComputedStyle(stickyNote).getPropertyValue('--scale') || '1';
                if (currentScale === '1') {
                    stickyNote.style.setProperty('--scale', '1.2');
                    stickyNote.style.transform = 'translate(-10%, -10%) scale(1.2)';
                } else {
                    stickyNote.style.setProperty('--scale', '1');
                    stickyNote.style.transform = '';
                }
            }
            maximizeBtn.addEventListener('click', handleMaximize);
            maximizeBtn.addEventListener('touchstart', handleMaximize, { passive: false });
            
            // 关闭功能（支持触摸事件）
            function handleClose(e) {
                e.stopPropagation();
                stickyNote.style.animation = 'popOut 0.3s forwards';
                setTimeout(() => {
                    if (stickyNote.parentNode) {
                        try {
                            stickyNote.parentNode.removeChild(stickyNote);
                            // 使用全局变量
                            if (window.noteCount && window.noteCount > 0) {
                                window.noteCount--;
                            }
                        } catch (e) {
                            console.log('删除便签时出错:', e);
                        }
                    }
                }, 300);
            }
            closeBtn.addEventListener('click', handleClose);
            closeBtn.addEventListener('touchstart', handleClose, { passive: false });
            
            // 闭合try块
            } catch (e) {
                console.log('添加便签时出错:', e);
            }
        }
            
            // 添加点击置顶功能（支持触摸事件）
            function handleClickToTop() {
                zIndexCounter++;
                stickyNote.style.zIndex = zIndexCounter;
            }
            stickyNote.addEventListener('mousedown', handleClickToTop);
            stickyNote.addEventListener('touchstart', handleClickToTop, { passive: true });
            
            // 添加拖拽功能
            makeDraggable(stickyNote);
        }
        
        // 调整便签高度以适应内容
        function adjustNoteHeight(note) {
            // 移除固定高度设置，让内容自然伸展
            note.style.height = 'auto';
            
            // 仅设置最小高度，确保有基本的显示空间
            note.style.minHeight = '80px';
        }
        
        // 获取随机颜色
        function getRandomColor() {
            return noteColors[Math.floor(Math.random() * noteColors.length)];
        }
        
        // 获取随机内容
        function getRandomContent() {
            return noteContents[Math.floor(Math.random() * noteContents.length)];
        }
        
        // 获取随机窗口标题
        function getRandomTitle() {
            return windowTitles[Math.floor(Math.random() * windowTitles.length)];
        }
        
        // 使元素可拖拽（支持鼠标和触摸事件）
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let isDragging = false;
            
            // 只有点击标题栏时才能拖拽
            const header = element.querySelector('.sticky-note-header');
            
            // 添加鼠标事件
            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('mousemove', dragMove);
            
            // 添加触摸事件（移动端支持）
            header.addEventListener('touchstart', dragStart, { passive: false });
            document.addEventListener('touchend', dragEnd);
            document.addEventListener('touchmove', dragMove, { passive: false });
            
            function getEventPosition(e) {
                if (e.touches && e.touches[0]) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }
            
            function dragStart(e) {
                // 仅在鼠标事件中使用preventDefault，避免触摸事件阻止默认行为
                if (e.type === 'mousedown') {
                    e.preventDefault();
                }
                isDragging = true;
                
                // 将当前元素置于顶层
                zIndexCounter++;
                element.style.zIndex = zIndexCounter;
                
                // 获取初始位置
                const pos = getEventPosition(e);
                pos3 = pos.x;
                pos4 = pos.y;
            }
            
            function dragMove(e) {
                if (!isDragging) return;
                
                // 获取当前位置
                const pos = getEventPosition(e);
                
                // 计算新位置
                pos1 = pos3 - pos.x;
                pos2 = pos4 - pos.y;
                pos3 = pos.x;
                pos4 = pos.y;
                
                // 设置元素新位置
                let newTop = element.offsetTop - pos2;
                let newLeft = element.offsetLeft - pos1;
                
                // 限制在视口内 - 优化移动设备处理
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                newTop = Math.max(0, Math.min(newTop, viewportHeight - element.offsetHeight));
                newLeft = Math.max(0, Math.min(newLeft, viewportWidth - element.offsetWidth));
                
                element.style.top = `${newTop}px`;
                element.style.left = `${newLeft}px`;
                
                // 拖拽时添加轻微的旋转效果
                const rotate = (Math.random() * 2 - 1).toFixed(2);
                element.style.transform = `rotate(${rotate}deg)`;
            }
            
            function dragEnd() {
                isDragging = false;
                // 轻微弹回效果
                element.style.transform = '';
            }
        }
        
        // 增强的安全初始化 - 完全兼容移动浏览器
        window.safeInit = function() {
            // 检测浏览器环境
            const ua = navigator.userAgent || '';
            const isWechat = ua.indexOf('MicroMessenger') !== -1;
            const isMobile = ua.indexOf('Android') !== -1 || 
                             ua.indexOf('iPhone') !== -1 || 
                             ua.indexOf('iPad') !== -1 || 
                             ua.indexOf('iPod') !== -1 ||
                             ua.indexOf('Mobile') !== -1;
            
            // 对所有移动设备都进行最保守的优化
            if (isMobile) {
                // 极致性能优化
                window.maxNotes = 8; // 进一步减少便签数量
                window.autoAddIntervalTime = 5000; // 更慢的添加速度
                
                // 禁用复杂动画效果
                window.disableComplexAnimations = true;
                
                // 添加移动设备可见提示
                try {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'mobile-status';
                    statusDiv.style.cssText = 'position:fixed; top:10px; left:50%; transform:translateX(-50%); background-color:#4CAF50; color:white; padding:8px 16px; border-radius:4px; z-index:9999; font-size:14px;';
                    statusDiv.textContent = '移动模式加载中...';
                    document.body.appendChild(statusDiv);
                    setTimeout(function() {
                        statusDiv.style.display = 'none';
                    }, 2000);
                } catch (e) {
                    // 静默失败
                }
            }
            
            // 确保所有必要变量已初始化
            window.maxNotes = window.maxNotes || 10;
            window.autoAddIntervalTime = window.autoAddIntervalTime || 4000;
            
            // 更长的延迟确保移动浏览器完全准备好
            setTimeout(function() {
                try {
                    // 先检查DOM元素是否存在
                    if (document.body && typeof init === 'function') {
                        init();
                    } else {
                        console.log('DOM未完全加载，延迟重试');
                        setTimeout(window.safeInit, 300); // 重试机制
                    }
                } catch (e) {
                    // 静默失败，避免在移动浏览器中弹出警告
                    console.log('初始化时出错:', e);
                }
            }, 300);
        };
        
        // 最兼容的初始化方式 - 优先使用window.onload作为后备
        if (window.addEventListener && window.addEventListener !== undefined) {
            window.addEventListener('DOMContentLoaded', window.safeInit, false);
        } else if (window.attachEvent && window.attachEvent !== undefined) {
            // IE兼容性
            window.attachEvent('onload', window.safeInit);
        } else {
            // 最终后备方案
            const oldOnload = window.onload || function(){};
            window.onload = function() {
                oldOnload();
                window.safeInit();
            };
        }
        
        // 添加视口调整事件处理
        window.addEventListener('resize', function() {
            // 当窗口大小改变时，重新计算位置，避免便签超出视口
            const notes = document.querySelectorAll('.sticky-note');
            const viewportWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
            const viewportHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
            
            notes.forEach(note => {
                let left = parseInt(note.style.left) || 0;
                let top = parseInt(note.style.top) || 0;
                
                // 确保便签在视口内
                left = Math.max(0, Math.min(left, viewportWidth - note.offsetWidth));
                top = Math.max(0, Math.min(top, viewportHeight - note.offsetHeight));
                
                note.style.left = `${left}px`;
                note.style.top = `${top}px`;
            });
        });
    </script>
</body>
</html>